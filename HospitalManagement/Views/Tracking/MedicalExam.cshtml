@using System.Text.Json
@using HospitalManagement.Helpers
@model HospitalManagement.ViewModels.ExaminationViewModel
@{
	ViewData["Title"] = "Khám bệnh";
}
@section Styles {
	<link rel="stylesheet" href="~/css/MedicalExamination.css" asp-append-version="true" />
	<style>
		#loadingOverlay {
			display: none !important;
		}
	</style>
}

<div class="medical-examination-wrapper">
	<div class="medical-examination-container">
		<div class="row medical-mb-4">
			<div class="col-12">
				<a asp-action="DoctorTodayAppointment" asp-controller="Tracking" class="medical-btn medical-btn-back">
					<i class="fas fa-arrow-left"></i> Trở về
				</a>
			</div>
		</div>

		<!-- Page Header -->
		<div class="medical-page-header mt-2 mx-4 d-flex justify-content-center align-items-center">
			<h2 class="medical-page-title text-center">
				<i class="fas fa-user-md"></i>
				Khám bệnh
			</h2>
		</div>

		<!-- Patient Info -->
		<div class="medical-patient-info medical-mb-4">
			<p><strong>Họ tên:</strong> @Model.PatientName</p>

			@* Kiểm tra và xử lý ngày sinh *@
			@if (!Model.DateOfBirth.HasValue || Model.DateOfBirth == DateTime.MinValue)
			{
				<form asp-action="UpdateDOB" method="post" class="mb-3">
					<input type="hidden" name="patientId" value="@Model.PatientID" />
					<div class="row g-2 align-items-center">
						<div class="col-auto">
							<label for="dob" class="col-form-label fw-bold">Ngày sinh:</label>
						</div>
						<div class="col-auto">
							<input type="date" id="dob" name="dob" class="form-control" required />
						</div>
						<div class="col-auto">
							<button type="submit" class="btn btn-sm btn-primary">Lưu ngày sinh</button>
						</div>
					</div>
					<div class="form-text text-danger">Ngày sinh chưa có. Vui lòng nhập!</div>
				</form>
			}
			else
			{
				<p><strong>Ngày sinh:</strong>@Model.DateOfBirth.Value.ToString("dd/MM/yyyy")</p>
			}

			<p><strong>Giới tính:</strong> @(Model.Gender == "M" ? "Nam" : Model.Gender == "F" ? "Nữ" : "Khác")</p>

			@if (!string.IsNullOrWhiteSpace(Model.ServiceName))
			{
				<p><strong>Dịch vụ:</strong> @Model.ServiceName</p>
			}
			else if (!string.IsNullOrWhiteSpace(Model.PackageName))
			{
				<p>
					<strong>Gói khám:</strong>
					<a href="/Package/Detail/@Model.PackageId">@Model.PackageName</a>
				</p>
			}
		</div>


		<form asp-controller="Tracking" asp-action="SaveExamination" id="MedicalForm" method="post">
			@Html.AntiForgeryToken()
			<input type="hidden" asp-for="AppointmentId" value="@Model.AppointmentId" />

			<!-- Examination Details -->
			<div class="medical-form-card">
				<div class="medical-section-header">
					<i class="fas fa-stethoscope medical-section-icon"></i>
					<h3 class="medical-section-title">Thông tin khám bệnh</h3>
				</div>

				<div class="row">
					<div class="col-md-6 medical-mb-3">
						<label class="medical-form-label">
							<i class="fas fa-clipboard-list"></i>Triệu chứng
						</label>
						<textarea asp-for="Symptoms" class="medical-form-control" rows="4" placeholder="Mô tả triệu chứng của bệnh nhân..."></textarea>
					</div>
					<div class="col-md-6 medical-mb-3">
						<label class="medical-form-label">
							<i class="fas fa-diagnoses"></i>Chẩn đoán / Ghi chú
						</label>
						<textarea asp-for="Diagnosis" class="medical-form-control" rows="4" placeholder="Kết quả chẩn đoán và ghi chú..."></textarea>
					</div>
					<div class="col-md-6 medical-mb-3">
						<label class="medical-form-label">
							<i class="fas fa-pills"></i>Đơn thuốc
						</label>
						<textarea asp-for="PrescriptionNote" class="medical-form-control" rows="4" placeholder="Kê đơn thuốc cho bệnh nhân..."></textarea>
					</div>
				</div>
			</div>

			<!-- Room Assignment Section -->
			<div class="medical-form-card medical-room-section">
				<div class="medical-section-header">
					<i class="fas fa-hospital medical-section-icon"></i>
					<h3 class="medical-section-title">Chỉ định phòng xét nghiệm</h3>
				</div>

				<div class="medical-room-controls">
					<div class="row g-3 align-items-stretch">
						<div class="col-md-5 medical-mb-3 d-flex flex-column">
							<label class="medical-form-label mb-2">
								<i class="fas fa-flask me-1"></i>Chọn loại xét nghiệm
							</label>
							<select class="medical-form-select form-control flex-grow-1" id="testSelector">
								<option value="">-- Chọn loại xét nghiệm --</option>
								@foreach (var test in Model.AvailableTests)
								{
									var isFromPackage = Model.TestRecords.Any(r => r.TestId == test.TestId);
									if (!isFromPackage)
									{
										<option value="@test.TestId">@test.Name</option>
									}
								}
							</select>
						</div>

						<div class="col-md-5 medical-mb-3 d-flex flex-column">
							<label class="medical-form-label mb-2">
								<i class="fas fa-door-open me-1"></i>Chọn phòng xét nghiệm
							</label>
							<div id="availableRoomListContainer" class="flex-grow-1 d-flex flex-column">
								<select class="medical-form-select form-control flex-grow-1" id="roomSelector">
									<option value="">-- Vui lòng chọn loại xét nghiệm trước --</option>
								</select>
							</div>
						</div>

						<div class="col-md-2 d-flex align-items-center">
							<button type="button" class="btn btn-primary btn-sm w-100" onclick="assignTest()">
								<i class="fas fa-plus me-1"></i>Thêm
							</button>
						</div>
					</div>
				</div>

				<div id="hiddenTestFields"></div>

				<!-- Assigned Rooms List -->
				<div class="medical-assigned-rooms medical-mt-4">
					<label class="medical-form-label medical-mb-3">
						<i class="fas fa-list-check"></i>
						Các phòng đã chỉ định
					</label>
					<ul class="medical-room-list" id="assignedRoomList"></ul>
				</div>
				<!-- Danh sách các xét nghiệm cần chỉ định phòng -->
				<div class="medical-form-card medical-mt-4">
					<div class="medical-section-header">
						<i class="fas fa-vials medical-section-icon"></i>
						<h3 class="medical-section-title">Các xét nghiệm từ gói khám. Vui lòng chỉ định phòng ở bảng bên dưới.</h3>
					</div>

					@if (Model.TestRecords != null && Model.TestRecords.Any())
					{
						<table class="table table-bordered table-hover">
							<thead class="table-light">
								<tr>
									<th>Tên xét nghiệm</th>
									<th>Phòng đã chỉ định</th>
									<th>Trạng thái</th>
									<th>Thao tác</th>
								</tr>
							</thead>
							<tbody>
								@foreach (var test in Model.TestRecords)
								{
									<tr id="test-row-@test.TestRecordId">
										<td>@test.TestName</td>
										<td>
											@if (!test.IsAssigned)
											{
												<select class="form-select form-select-sm"
														id="room-selector-@test.TestRecordId">
													<option value="">-- Chọn phòng --</option>
													@if (Model.AvailableRoomsPerTest.ContainsKey(test.TestId))
													{
														foreach (var room in Model.AvailableRoomsPerTest[test.TestId])
														{
															<option value="@room.RoomId">@room.RoomName</option>
														}
													}
												</select>
											}
											else
											{
												<span id="assigned-room-@test.TestRecordId">@test.RoomName</span>
											}
										</td>
										<td id="test-status-@test.TestRecordId">
											@{
												var status = test.TestStatus;
												// Debug: Hiển thị giá trị thực tế
												string displayStatus = status switch
												{
													AppConstants.TestStatus.WaitingForPayment => "Chờ thanh toán",
													AppConstants.TestStatus.Paid => "Đã thanh toán",
													AppConstants.TestStatus.Pending => "Chưa bắt đầu",
													AppConstants.TestStatus.Ongoing => "Đang thực hiện",
													AppConstants.TestStatus.Failed => "Thất bại",
													AppConstants.TestStatus.Canceled => "Đã huỷ",
													AppConstants.TestStatus.Completed => "Hoàn thành",
													_ => "Không rõ"
												};
											}
											@displayStatus
										</td>
										<td>
											@if (!test.IsAssigned)
											{
												<button type="button"
														class="btn btn-sm btn-outline-primary"
														onclick="assignPackageTest(@test.TestRecordId, @test.TestId, @Model.AppointmentId)">
													<i class="fas fa-door-open"></i> Chỉ định phòng
												</button>
											}
											else
											{
												<span class="text-success">Đã chỉ định</span>
											}
										</td>
									</tr>
								}

							</tbody>

						</table>
					}
					else
					{
						<p class="text-muted">Không có xét nghiệm nào.</p>
					}
				</div>

			</div>

			<!-- Action Buttons -->
			<div class="medical-btn-group">
				<button type="submit" name="action" value="save" class="medical-btn medical-btn-save">
					<i class="fas fa-save"></i>Lưu thông tin
				</button>

				<button type="submit" name="action" value="submit" class="medical-btn medical-btn-complete"
						@(ViewBag.AllTestsCompleted == false ? "disabled" : "")>
					<i class="fas fa-check-circle"></i>Hoàn thành khám bệnh
				</button>
			</div>

			@if (ViewBag.AllTestsCompleted == false)
			{
				<div class="medical-alert medical-alert-warning medical-mt-2">
					<i class="fas fa-exclamation-triangle"></i>
					Cần hoàn thành tất cả xét nghiệm trước khi kết thúc khám bệnh.
				</div>
			}
		</form>
	</div>
</div>

@section Scripts {
	<script>
		let trackings = @Html.Raw(ViewBag.AssignedRoom);
		console.log("trackings = ", trackings);
	</script>
	<script src="~/js/MedicalExamination.js" asp-append-version="true"></script>
}