@model InvoiceDetail
@{
	ViewBag.Title = "Thanh Toán";
	var qrLink = ViewBag.PaymentUrl as string;
}

<div class="container py-5">
	<div class="card mx-auto" style="max-width: 600px;">
		<div class="card-header bg-primary text-white">
			<h4 class="mb-0" style="color: white;">
				<i class="fas fa-credit-card"></i> Thanh Toán Tiền Cuộc Hẹn
			</h4>
		</div>
		<div class="card-body">
			<dl class="row">
				@if (Model.ItemType == "Service")
				{
					<dt class="col-sm-4">Loại dịch vụ:</dt>
					<dd class="col-sm-8">@Model.ItemName</dd>

					<dt class="col-sm-4">Giá dịch vụ:</dt>
					<dd class="col-sm-8">@Model.UnitPrice.ToString("N0") vnd</dd>
				}
				else
				{
					<dt class="col-sm-4">Gói khám:</dt>
					<dd class="col-sm-8">@Model.ItemName</dd>

					<dt class="col-sm-4">Giá khám:</dt>
					<dd class="col-sm-8">@Model.UnitPrice.ToString("N0") vnd</dd>
				}

				<dt class="col-sm-4">Trạng thái:</dt>
				<dd class="col-sm-8">
					@{
						var statusText = Model.PaymentStatus switch
						{
							"Paid" => "Đã thanh toán",
							"Unpaid" => "Chưa thanh toán",
							_ => Model.PaymentStatus
						};
					}
					@statusText
				</dd>
			</dl>

			<div class="alert alert-warning">
				Vui lòng quét mã QR hoặc ấn nút bên dưới để mở VNPay.
			</div>

			@if (!string.IsNullOrEmpty(qrLink))
			{

				<div class="text-center">
					<img src="@Url.Action("GenerateQr", "Payment", new { url = qrLink })"
						 alt="QR Code VNPAY"
						 style="width: 300px; height: 300px; border: 8px solid #e5e5e5; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);" />
				</div>

				<div class="text-center">
					<a href="@qrLink" class="btn btn-primary mt-2" target="_blank">Mở VNPay</a>
				</div>
			}
			else
			{
				<div class="alert alert-danger">Không tạo được mã QR thanh toán.</div>
			}

			<div class="mt-4">
				<form asp-action="PayAppointmentConfirmed" method="post">
					<input type="hidden" name="invoiceId" value="@Model.InvoiceDetailId" />
					<div class="d-flex justify-content-between">
						<a asp-action="StartAppointmentProcess" asp-controller="Tracking" class="btn btn-secondary">
							<i class="fas fa-arrow-left"></i> Quay lại
						</a>
						<button type="submit" class="btn btn-success" onclick="return confirm('Bạn có chắc chắn muốn xác nhận đã thu tiền mặt cho hóa đơn này?');">
							<i class="fas fa-check"></i> Xác nhận đã thanh toán tiền mặt
						</button>
						@* <p>@Model.InvoiceDetailId</p> *@
					</div>
				</form>
			</div>

		</div>
	</div>
</div>
