@model HospitalManagement.ViewModels.TestResultViewModel

@{
    ViewData["Title"] = "Kết quả xét nghiệm";
}
@section Styles{
    <style>
        .form-control-plaintext {
            color: #212529; /* Gần như đen, Bootstrap mặc định dùng */
            font-weight: 600; /* Tăng độ đậm chữ */
        }
    </style>
}

<div class="container my-5">
    <h2 class="text-primary fw-bold mb-4">Kết quả xét nghiệm</h2>
    <div class="p-4 shadow-sm border rounded bg-white">
        <div class="mb-3">
            <label class="form-label fw-bold">Ngày sinh:</label>
            <div class="form-control-plaintext">
                @(Model.DOB == null ? "Chưa có" : Model.DOB.Value.ToString("dd/MM/yyyy"))
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Tên xét nghiệm:</label>
            <div class="form-control-plaintext">@Model.TestName</div>
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Bệnh nhân:</label>
            <div class="form-control-plaintext">@Model.PatientFullName</div>
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Giới tính:</label>
            <div class="form-control-plaintext">@(Model.Gender == "M" ? "Nam" : "Nữ")</div>
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Ngày hoàn thành:</label>
            <div class="form-control-plaintext">@Model.CompletedAt?.ToString("dd/MM/yyyy HH:mm")</div>
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Ghi chú:</label>
            <div class="form-control-plaintext">@Model.Note</div>
        </div>
        @if (!string.IsNullOrEmpty(Model.ResultFileName))
        {
            <div class="mb-3">
                <label class="form-label fw-bold">Tệp kết quả:</label>
                <div>
                    @if (Model.ResultFileName.EndsWith(".pdf"))
                    {
                        <a href="#" data-bs-toggle="modal" data-bs-target="#pdfModal"
                           data-pdf-src="@Url.Content($"~/img/TestResult/{Model.ResultFileName}")">
                            <div class="border rounded p-2 bg-light text-center" style="cursor: pointer;">
                                <i class="fas fa-file-pdf fa-3x text-danger"></i><br />
                                <small>Bấm để xem PDF chi tiết</small>
                            </div>
                        </a>
                    }
                    else
                    {
                        <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal"
                           data-image-src="@Url.Content($"~/img/TestResult/{Model.ResultFileName}")">
                            <img src="@Url.Content($"~/img/TestResult/{Model.ResultFileName}")"
                                 alt="Ảnh kết quả"
                                 class="img-fluid border rounded"
                                 style="max-height: 300px; cursor: pointer;" />
                        </a>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-warning mb-3">Chưa có tệp kết quả được đính kèm.</div>
        }

    </div>
</div>

<!-- Modal xem ảnh -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 60vw;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ảnh kết quả</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body text-center p-0">
                <img id="modalImage" src="" alt="Ảnh kết quả" class="img-fluid w-100" style="max-height: 60vh;" />
            </div>
        </div>
    </div>
</div>

<!-- Modal xem PDF -->
<div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 90vw;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Kết quả xét nghiệm (PDF)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body p-0" style="height: 80vh;">
                <iframe id="pdfViewer" src="" width="100%" height="100%" frameborder="0"></iframe>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const imageModal = document.getElementById('imageModal');
            const pdfModal = document.getElementById('pdfModal');

            if (imageModal) {
                imageModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const imageSrc = button.getAttribute('data-image-src');
                    document.getElementById('modalImage').src = imageSrc;
                });

                imageModal.addEventListener('hidden.bs.modal', function () {
                    document.getElementById('modalImage').src = '';
                });
            }

            if (pdfModal) {
                pdfModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const pdfSrc = button.getAttribute('data-pdf-src');
                    document.getElementById('pdfViewer').src = pdfSrc;
                });

                pdfModal.addEventListener('hidden.bs.modal', function () {
                    document.getElementById('pdfViewer').src = '';
                });
            }
        });
    </script>
}
