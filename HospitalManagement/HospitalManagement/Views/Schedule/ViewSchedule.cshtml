@model List<DoctorScheduleViewModel.ScheduleItem>

@{
	ViewData["Title"] = "Lịch làm việc trong tuần";

	int selectedYear = (int)ViewBag.SelectedYear;
	DateOnly selectedWeekStart = (DateOnly)ViewBag.SelectedWeekStart;
	DateOnly selectedWeekEnd = selectedWeekStart.AddDays(6);
	DateOnly firstWeekStart = new DateOnly(selectedYear, 1, 1).AddDays(-(int)new DateTime(selectedYear, 1, 1).DayOfWeek + 1);
	DateOnly lastWeekStart = new DateOnly(selectedYear, 12, 25).AddDays(-(int)new DateTime(selectedYear, 12, 25).DayOfWeek + 1);

	DateOnly prevWeek = selectedWeekStart.AddDays(-7);
	DateOnly nextWeek = selectedWeekStart.AddDays(7);

	var daysInWeek = Enumerable.Range(0, 7).Select(i => selectedWeekStart.AddDays(i)).ToList();
	var slotsPerDay = 6;
	var grouped = Model.GroupBy(s => (s.SlotIndex, s.Day)).ToDictionary(g => g.Key, g => g.ToList());
}


<style>
	table td {
		vertical-align: top;
	}

	.schedule-card {
		border: 1px solid #007bff;
		border-top: 4px solid #007bff;
		border-radius: 8px;
		padding: 10px;
		background-color: #f8faff;
		margin-bottom: 5px;
		box-shadow: 0 2px 5px rgba(0, 123, 255, 0.1);
	}

		.schedule-card i {
			color: #007bff;
		}

		.schedule-card .fw-bold {
			font-size: 1rem;
		}

	.bg-light {
		background-color: #f8f9fa;
	}
</style>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<div class="container mt-4 mb-3">

	<div class="justify-content-center">
		<h1 class="mb-3">Lịch làm việc trong tuần</h1>
	</div>
	<div>
		<!-- Dropdown chọn năm bên trái -->
		<div class="d-flex justify-content-between align-items-center mb-3">
			<select id="yearDropdown" class="form-select" style="width:100px;" onchange="updateSchedule(this.value)">
				@for (int y = 2023; y <= (int)DateTime.Now.Year + 1; y++)
				{
					if (y == selectedYear)
					{
						<option value="@y" selected>@y</option>
					}
					else
					{
						<option value="@y">@y</option>
					}
				}
			</select>
		</div>
	</div>
	<!-- Bộ chọn tuần, nút điều hướng -->
	<div id="scheduleTable" >
		<div class="d-flex justify-content-center align-items-center mb-3 gap-2">
			<!-- Cụm nút tuần ở giữa -->
			<div class="d-flex align-items-center gap-2">
				<!-- Nút tuần trước -->
				<button class="btn btn-outline-primary" onclick="changeWeek(-1)" @(selectedWeekStart <= firstWeekStart ? "disabled" : "")>
					<i class="bi bi-chevron-left"></i>
				</button>

				<!-- Dropdown tuần -->
				<select id="weekDropdown" class="form-select" onchange="updateSchedule()" style="width:250px;">
					@{
						var start = firstWeekStart;
						var end = lastWeekStart;
						while (start <= end)
						{
							var endOfWeek = start.AddDays(6);
							var label = $"{start:dd/MM} - {endOfWeek:dd/MM}";
							if (start == selectedWeekStart)
							{
								<option value="@start.ToString("yyyy-MM-dd")" selected> @label </option>
							}
							else
							{
								<option value="@start.ToString("yyyy-MM-dd")"> @label </option>
							}

							start = start.AddDays(7);
						}
					}
				</select>

				<!-- Nút tuần sau -->
				<button class="btn btn-outline-primary" onclick="changeWeek(1)" @(selectedWeekStart >= lastWeekStart ? "disabled" : "")>
					<i class="bi bi-chevron-right"></i>
				</button>
			</div>

			<!-- (Có thể để trống hoặc thêm gì đó bên phải nếu muốn căn giữa tốt hơn) -->
			<div style="width:100px;"></div>
		</div>



		<!-- Bảng lịch -->
		<div>
			<table class="table table-bordered text-center">
				<thead class="table-light">
					<tr>
						<th>Slot</th>
						@foreach (var day in daysInWeek)
						{
							<th>@day.ToString("ddd dd/MM")</th>
						}
					</tr>
				</thead>
				<tbody>
					@for (int slot = 1; slot <= slotsPerDay; slot++)
					{
						<tr>
							<td><strong>Slot @slot</strong></td>
							@foreach (var day in daysInWeek)
							{
								var key = (slot, day);
								<td>
									@if (grouped.ContainsKey(key))
									{
										foreach (var item in grouped[key])
										{
											<a href="#">
												<div class="schedule-card">
													<div><i class="bi bi-clock me-1"></i> @item.StartTime - @item.EndTime</div>
													<div><i class="bi bi-building me-1"></i> @item.RoomName</div>
												</div>
											</a>
										}
									}
								</td>
							}
						</tr>
					}

				</tbody>
			</table>
		</div>
	</div>

</div>

 @section Scripts { 
 	<script src="~/js/Schedule.js" asp-append-version="true"></script> 
 } 
