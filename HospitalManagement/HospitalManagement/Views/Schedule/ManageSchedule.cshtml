@model List<Slot>

@{
	ViewData["Title"] = "Quản lí lịch làm việc";

	int selectedYear = (int)ViewBag.SelectedYear;
	DateOnly selectedWeekStart = (DateOnly)ViewBag.SelectedWeekStart;
	DateOnly selectedWeekEnd = selectedWeekStart.AddDays(6);
	DateOnly firstWeekStart = new DateOnly(selectedYear, 1, 1).AddDays(-((int)new DateTime(selectedYear, 1, 1).DayOfWeek + 6) % 7);
	DateOnly lastWeekStart = new DateOnly(selectedYear, 12, 25).AddDays(-((int)new DateTime(selectedYear, 12, 25).DayOfWeek + 6) % 7);

	DateOnly prevWeek = selectedWeekStart.AddDays(-7);
	DateOnly nextWeek = selectedWeekStart.AddDays(7);

	var daysInWeek = Enumerable.Range(0, 7).Select(i => selectedWeekStart.AddDays(i)).ToList();
	var slotsPerDay = Model.Count;
}


<style>
	table td {
		vertical-align: top;
	}

	.schedule-card {
		border: 1px solid #007bff;
		border-top: 4px solid #007bff;
		border-radius: 5px;
		padding: 10px;
		background-color: #f8faff;
		margin-bottom: 5px;
		box-shadow: 0 2px 5px rgba(0, 123, 255, 0.1);
	}

		.schedule-card i {
			color: #007bff;
		}

		.schedule-card .fw-bold {
			font-size: 1rem;
		}

	.bg-light {
		background-color: #f8f9fa;
	}
    #card {
    width: 200px;
    padding: 10px;
    background-color: #f8faff;
    color: black;
    border: 1px solid #007bff;
    border-top: 4px solid #007bff;
    border-radius: 5px;
}

#card.complete {
    border-color: #28a745 !important;
    border-top-color: #28a745 !important;
    background-color: #e6f9ea !important;
}


.slot-inactive {
    border: 1px solid #007bff;
    border-top: 4px solid #007bff;
    background-color: #f8faff;
    color: black;
}
.slot-active {
    border: 1px solid #fed03a;
    border-top: 4px solid #fed03a;
    background-color: #fff3cd;
    color: black;
}
.slot-success{
    border: 1px solid #28a745;
    border-top: 4px solid #28a745;
    background-color: #e6f9ea;
    color: black;
}
.slot-fail{
    border: 1px solid #ff1b1b;
    border-top: 4px solid #ff1b1b;
    background-color: #ffaa90;
    color: black;
}
</style>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<div class="container mt-4 mb-3">

	<div class="justify-content-center">
		<h1 class="mb-3">Lịch làm việc</h1>
	</div>
      @if (TempData["error"] != null)
		{
			<div id="popup-alert" class="popup-alert alert alert-danger alert-dismissible fade show text-center"
				 role="alert" style="z-index: 1055; border-radius: 8px;">
				<div>@TempData["error"]</div>
			</div>
		}
		else if (TempData["success"] != null)
		{
			<div id="popup-alert" class="popup-alert alert alert-success alert-dismissible fade show text-center"
				 role="alert" style="z-index: 1055; border-radius: 8px;">
				<div>@TempData["success"]</div>
			</div>
		}
    @* thẻ nhân viên *@
    <div class="d-flex align-items-start gap-3 mb-4">

        <!-- Khối select -->
        <div class="d-flex gap-2 flex-wrap">
            <select id="roleSelect" class="form-select form-select-sm" style="width:150px;">
                <option value="">Role</option>
                <option value="Doctor">Doctor</option>
                <option value="Cashier">Cashier</option>
                <option value="Sale">Sale</option>
            </select>

            <select id="staffSelect" disabled class="form-select form-select-sm" style="width:180px;">
                <option value="">Chọn nhân viên</option>
            </select>

            <select id="roomSelect" class="form-select form-select-sm" style="width:180px;">
                <option value="">Chọn phòng</option>
                <option value="101">Phòng 101</option>
                <option value="102">Phòng 102</option>
            </select>
        </div>

        <!-- Khối chứa CARD -->
        <div class="border rounded p-2" style="min-width:230px;">
            <div class="fw-bold mb-2 text-center">Thông tin đã chọn</div>
            <div id="card" class="schedule-card">
                <div id="cardContent"></div>
            </div>
        </div>

        <div>
            <button id="confirmAddBtn" class="btn btn-primary mt-3">Thêm vào các slot đã chọn</button>

            <!-- Hộp xác nhận hiện ra bên dưới -->
            <div id="confirmBox" class="mt-3" style="display:none;">
                <div class="alert alert-warning p-3">
                    Bạn có muốn thêm vào những slot này không?
                    <div class="mt-2 d-flex gap-2">
                        <button id="btnYes" class="btn btn-success btn-sm">Có</button>
                        <button id="btnNo" class="btn btn-secondary btn-sm">Không</button>
                    </div>
                </div>
            </div>
        </div>

    </div>


    <!-- Dropdown chọn năm bên trái -->
    <div>
		<div class="d-flex justify-content-between align-items-center mb-3">
			<select id="yearDropdown" class="form-select" style="width:100px;" onchange="updateSchedule(this.value)">
				@for (int y = 2023; y <= (int)DateTime.Now.Year + 1; y++)
				{
					if (y == selectedYear)
					{
						<option value="@y" selected>@y</option>
					}
					else
					{
						<option value="@y">@y</option>
					}
				}
			</select>
		</div>
	</div>
	<!-- Bộ chọn tuần, nút điều hướng, bảng -->
	<div id="scheduleTable" >
		<div class="d-flex justify-content-center align-items-center mb-3 gap-2">
			<!-- Cụm nút tuần ở giữa -->
			<div class="d-flex align-items-center gap-2">
				<!-- Nút tuần trước -->
				<button class="btn btn-outline-primary" onclick="changeWeek(-1)" @(selectedWeekStart <= firstWeekStart ? "disabled" : "")>
					<i class="bi bi-chevron-left"></i>
				</button>

				<!-- Dropdown tuần -->
				<select id="weekDropdown" class="form-select" onchange="updateSchedule()" style="width:250px;">
					@{
						var start = firstWeekStart;
						var end = lastWeekStart;
						while (start <= end)
						{
							var endOfWeek = start.AddDays(6);
							var label = $"{start:dd/MM} - {endOfWeek:dd/MM}";
							if (start == selectedWeekStart)
							{
								<option value="@start.ToString("yyyy-MM-dd")" selected> @label </option>
							}
							else
							{
								<option value="@start.ToString("yyyy-MM-dd")"> @label </option>
							}

							start = start.AddDays(7);
						}
					}
				</select>

				<!-- Nút tuần sau -->
				<button class="btn btn-outline-primary" onclick="changeWeek(1)" @(selectedWeekStart >= lastWeekStart ? "disabled" : "")>
					<i class="bi bi-chevron-right"></i>
				</button>
			</div>

			<!-- (Có thể để trống hoặc thêm gì đó bên phải nếu muốn căn giữa tốt hơn) -->
			<div style="width:100px;"></div>
		</div>


		<!-- Bảng lịch -->
		<div>
			<table class="table table-bordered text-center">
				<thead class="table-light">
					<tr>
						<th>Slot</th>
						@foreach (var day in daysInWeek)
						{
							<th>@day.ToString("ddd dd/MM")</th>
						}
					</tr>
				</thead>
				<tbody>
					@for (int slot = 1; slot <= slotsPerDay; slot++)
					{
						<tr>
							<td><strong>Slot @slot</strong></td>
							@foreach (var day in daysInWeek)
							{
								<td>
                                    <div class="schedule-slot" data-slot="@slot" data-date="@day.ToString("yyyy-MM-dd")">
                                        <input type="hidden" name="SlotStates[@day.ToString("yyyy-MM-dd")_@slot]" value="false" />
                                        <div class="schedule-card slot-inactive"
                                            id="@($"{day:yyyy-MM-dd}_{slot}")"
                                            data-start="@Model[slot - 1].StartTime.ToString("HH:mm")"
                                            data-end="@Model[slot - 1].EndTime.ToString("HH:mm")"
                                            data-assigned="false"
                                            onclick="toggleSlot(this)">
                                            <div><i class="bi bi-clock me-1"></i> @Model[slot - 1].StartTime.ToString("HH:mm") - @Model[slot - 1].EndTime.ToString("HH:mm")</div>
                                            <div><i class="fas fa-bars"></i> Chưa chọn</div>
                                        </div>
                                    </div>
								</td>
							}
						</tr>
					}
				</tbody>
			</table>
		</div>
	</div>

</>

 @section Scripts { 
    
 	<script src="~/js/ManageSchedule.js" asp-append-version="true"></script> 
    <script src="~/js/CardFactory.js" asp-append-version="true"></script> 

 } 
