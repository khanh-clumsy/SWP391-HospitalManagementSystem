@using X.PagedList
@model IPagedList<HospitalManagement.ViewModels.FeedbackManageViewModel>

@{
    ViewData["Title"] = "Quản lý Feedback";
    string name = ViewBag.Name ?? "";
    string rating = ViewBag.Rating?.ToString() ?? "";
    string date = ViewBag.Date ?? "";
}
<div class="container">

    <h2 class="mb-4">Quản lý Feedback</h2>


    <form method="get" class="row mb-4 g-2">
        <div class="col-md-4">
            <input name="name" value="@name" class="form-control" placeholder="Tên bệnh nhân" />
        </div>
        <div class="col-md-3">
            <select name="rating" class="form-select">
                <option value="">-- Đánh giá (1-5) --</option>
                @foreach (var i in new[] { 1, 2, 3, 4, 5 })
                {
                    <option value="@i" selected="@(ViewBag.Rating != null && (int)ViewBag.Rating == i ? "selected" : null)">
                        @i sao
                    </option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <input type="date" name="date"
                   class="form-control"
                   value="@date" />
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Lọc</button>
        </div>
    </form>

    <form asp-action="UpdateFeedbackSpecial" method="post">
        <table class="table table-bordered text-center align-middle">
            <thead class="table-light">
                <tr>
                    <th>Bệnh nhân</th>
                    <th>Dịch vụ/Gói</th>
                    <th>Đánh giá</th>
                    <th>Nhận xét</th>
                    <th>Ngày tạo</th>
                    <th>Đặc biệt</th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < Model.Count; i++)
                {
                    <tr>
                        <input type="hidden" name="feedbacks[@i].FeedbackId" value="@Model[i].FeedbackId" />
                        <td>@Model[i].PatientName</td>
                        <td>@Model[i].ItemName</td>
                        <td>@Model[i].Rating</td>
                        <td>@Model[i].Comment</td>
                        <td>@Model[i].CreatedAt.ToString("dd/MM/yyyy")</td>
                        <td>
                            <input type="checkbox" name="feedbacks[@i].IsSpecial" value="true"
                                   @(Model[i].IsSpecial ? "checked" : "") />
                            <input type="hidden" name="feedbacks[@i].IsSpecial" value="false" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="text-end mt-3">
            <button type="submit" class="btn btn-success">Lưu thay đổi</button>
        </div>
    </form>
    <!-- Pagination start -->
    @{
    int maxPagesToShow = 5;
    int startPage = Model.PageNumber - maxPagesToShow / 2;
    if (startPage < 1) startPage = 1;

    int endPage = startPage + maxPagesToShow - 1;
    if (endPage > Model.PageCount)
    {
        endPage = Model.PageCount;
        startPage = Math.Max(1, endPage - maxPagesToShow + 1);
    }
    }
    @if (Model.PageCount > 1)
    {
        <div class="d-flex justify-content-center mt-5">
            <nav>
                <ul class="pagination">

                    @* Previous button *@
                    <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                        <a class="page-link" href="@(Model.HasPreviousPage ? Url.Action("ManageFeedback", new {
									page = Model.PageNumber - 1,
									name = ViewBag.Name,
									rating = ViewBag.Rating,
                                    date = ViewBag.Date}) : "#")" tabindex="-1">Trước</a>
                    </li>

                    @* Trang đầu nếu startPage > 1 và dấu "..." *@
                    @if (startPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("ManageFeedback", new {
                                    page = 1,
									name = ViewBag.Name,
									rating = ViewBag.Rating,
                                    date = ViewBag.Date})">1</a>
                        </li>
                        @if (startPage > 2)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }
                    }

                    @* Các trang hiển thị trong khoảng từ startPage đến endPage *@
                    @for (int i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                            <a class="page-link" href="@Url.Action("ManageFeedback", new {
                                    page = i,
									name = ViewBag.Name,
									rating = ViewBag.Rating,
                                    date = ViewBag.Date})">@i</a>
                                </li>
                            }

                    @* Trang cuối nếu endPage < total pages và dấu "..." *@
                    @if (endPage < Model.PageCount)
                    {
                        if (endPage < Model.PageCount - 1)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("ManageFeedback", new {
                                    page = Model.PageCount,
									name = ViewBag.Name,
									rating = ViewBag.Rating,
                                    date = ViewBag.Date})">@Model.PageCount</a>
                                </li>
                            }

                            @* Next button *@
                    <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                        <a class="page-link" href="@(Model.HasNextPage ? Url.Action("ManageFeedback", new {
                                    page = Model.PageNumber + 1,
									name = ViewBag.Name,
									rating = ViewBag.Rating,
                                    date = ViewBag.Date}) : "#")">Sau</a>
                    </li>

                </ul>
            </nav>
        </div>
    }
    <!-- Pagination end-->
</div>
