@model HospitalManagement.ViewModels.Booking.BookingByDoctorViewModel
@{
    ViewData["Title"] = "Đặt Lịch Theo Bác Sĩ";
    var minDate = DateTime.Now.AddDays(1).ToString("yyyy-MM-dd");
    var isReadonly = !string.IsNullOrEmpty(Model.Name);
}

@section Styles {
    <link rel="stylesheet" href="~/css/booking.css" asp-append-version="true" />
}

<div class="container-xxl py-5">
  <div class="container">
    <div class="form-header text-center mb-4">
      <h2><i class="fas fa-user-md text-primary me-2"></i>Đặt Lịch Theo Bác Sĩ</h2>
      <p>Chọn chuyên khoa, bác sĩ, ngày, giờ và dịch vụ phù hợp.</p>
      <div class="mt-3">
        <a asp-action="BookingByService" asp-controller="Appointment" class="btn btn-outline-primary me-2">
          <i class="fas fa-briefcase-medical me-1"></i>Đặt Lịch Theo Dịch Vụ
        </a>
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">
          <i class="fas fa-home me-1"></i>Về Trang Chủ
        </a>
      </div>
    </div>

    <form asp-action="BookingByDoctor" asp-controller="Appointment" method="post" id="doctorForm">
      @Html.AntiForgeryToken()

      <!-- Thông Tin Bệnh Nhân -->
      <div class="section-title mb-3">
        <h3><i class="fas fa-user text-primary me-2"></i>Thông Tin Cá Nhân</h3>
      </div>
      <div class="row g-3 mb-4">
        <div class="col-12">
          <input asp-for="Name" class="form-control" placeholder="Họ và tên" readonly="@(isReadonly ? "readonly" : null)" />
          <span asp-validation-for="Name" class="text-danger"></span>
        </div>
        <div class="col-sm-6">
          <input asp-for="Email" class="form-control" placeholder="Email" readonly="@(isReadonly ? "readonly" : null)" />
          <span asp-validation-for="Email" class="text-danger"></span>
        </div>
        <div class="col-sm-6">
          <input asp-for="PhoneNumber" class="form-control" placeholder="Số điện thoại" readonly="@(isReadonly ? "readonly" : null)" />
          <span asp-validation-for="PhoneNumber" class="text-danger"></span>
        </div>
      </div>

      <!-- Chọn Chuyên Khoa -->
      <div class="section-title mb-3">
        <h3><i class="fas fa-building text-primary me-2"></i>Chọn Chuyên Khoa</h3>
      </div>
      <div class="row g-3 mb-4">
        <div class="col-12">
          <select asp-for="SelectedDepartmentId"
                  id="departmentDropdown"
                  asp-items="Model.DepartmentOptions"
                  class="form-select">
            <option value="">-- Chọn chuyên khoa --</option>
          </select>
          <span asp-validation-for="SelectedDepartmentId" class="text-danger"></span>
        </div>
      </div>

      <!-- Ô tìm bác sĩ -->
      <div class="section-title mb-3 doctor-search-title" style="display:none;">
        <h5><i class="fas fa-search text-primary me-2"></i>Tìm Bác Sĩ</h5>
      </div>
      <div class="row g-3 mb-4 doctor-search" style="display:none;">
        <div class="col-12">
          <input type="text"
                 id="doctorSearch"
                 class="form-control"
                 placeholder="Nhập tên bác sĩ..." />
        </div>
      </div>

      <!-- Chọn Bác Sĩ -->
      <div class="section-title mb-3 doctor-select-title" style="display:none;">
        <h3><i class="fas fa-user-md text-primary me-2"></i>Chọn Bác Sĩ</h3>
      </div>
      <div class="row g-3 mb-4 doctor-dropdown" style="display:none;">
        <div class="col-12">
          <select asp-for="SelectedDoctorId"
                  id="doctorDropdown"
                  class="form-select">
            <option value="">-- Chọn bác sĩ --</option>
          </select>
          <span asp-validation-for="SelectedDoctorId" class="text-danger"></span>
        </div>
      </div>

      <!-- Chọn Ngày -->
      <div class="section-title mb-3">
        <h3><i class="fas fa-calendar-day text-primary me-2"></i>Chọn Ngày Khám</h3>
      </div>
      <div class="row g-3 mb-4">
        <div class="col-12">
          <input asp-for="AppointmentDate"
                 id="appointmentDate"
                 type="date"
                 class="form-control"
                 min="@minDate" />
          <span asp-validation-for="AppointmentDate" class="text-danger"></span>
        </div>
      </div>

      <!-- Chọn Giờ -->
      <div class="section-title mb-3">
        <h3><i class="fas fa-clock text-primary me-2"></i>Chọn Giờ Khám</h3>
      </div>
      <div id="time-slots-container" class="time-slots-grid"></div>
      <input type="hidden" asp-for="SelectedSlotId" id="SelectedSlotId" />

      <!-- Chọn Dịch Vụ -->
      <div class="section-title mb-3 service-title" style="display:none;">
        <h3><i class="fas fa-briefcase-medical text-primary me-2"></i>Chọn Dịch Vụ</h3>
      </div>
      <div class="row g-3 mb-4 service-dropdown" style="display:none;">
        <div class="col-12">
          <select asp-for="SelectedServiceId"
                  id="serviceDropdown"
                  asp-items="Model.ServiceOptions"
                  class="form-select">
            <option value="">-- Chọn dịch vụ --</option>
          </select>
          <span asp-validation-for="SelectedServiceId" class="text-danger"></span>
        </div>
      </div>

      <!-- Ghi Chú -->
      <div class="section-title mb-3">
        <h3><i class="fas fa-notes-medical text-primary me-2"></i>Ghi Chú (Tùy chọn)</h3>
      </div>
      <textarea asp-for="Note"
                class="form-control mb-4"
                rows="4"
                placeholder="Mô tả triệu chứng hoặc yêu cầu..."></textarea>
      <span asp-validation-for="Note" class="text-danger"></span>

      <!-- Nút Đặt Hẹn -->
      <div class="text-center">
        <button type="submit" class="submit-btn btn btn-primary" disabled>
          <i class="fas fa-calendar-check me-2"></i>Đặt Lịch Hẹn
        </button>
      </div>
    </form>
  </div>
</div>

@section Scripts {
  <script src="~/js/BookingByDoctor.js" asp-append-version="true"></script>
  <script>
    // Khi chọn chuyên khoa -> load danh sách bác sĩ
    $('#departmentDropdown').on('change', function() {
      var deptId = $(this).val();
      const $ddl = $('#doctorDropdown');
      if (!deptId) {
        $('.doctor-search-title, .doctor-search, .doctor-select-title, .doctor-dropdown').hide();
        $ddl.empty().append('<option value="">-- Chọn bác sĩ --</option>');
        $('#time-slots-container').hide().empty();
        $('.service-title,.service-dropdown').hide();
        return;
      }
      $.getJSON('/Appointment/GetDoctorsByDepartment', { departmentId: deptId })
        .done(function(doctors) {
          $ddl.empty().append('<option value="">-- Chọn bác sĩ --</option>');
          doctors.forEach(d => $ddl.append(`<option value="${d.id}">${d.name}</option>`));
          $('.doctor-search-title, .doctor-search, .doctor-select-title, .doctor-dropdown').show();
        })
        .fail(function() {
          alert('Không tải được danh sách bác sĩ');
        });
    });

    // Lọc tên bác sĩ
    $('#doctorSearch').on('input', function(){
      var term = $(this).val().toLowerCase();
      $('#doctorDropdown option').each(function(){
        if (!$(this).val()) return;
        var txt = $(this).text().toLowerCase();
        $(this).prop('hidden', term && !txt.includes(term));
      });
    });
  </script>
}
